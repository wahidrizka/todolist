name: Deploy to VM

on:
    release:
        types: [ published ]            # deploy otomatis saat GitHub Release published
    workflow_dispatch: # opsi deploy manual (mis. rollback/tes)
        inputs:
            tag:
                description: "Image tag to deploy (e.g. v0.2.1 or latest)"
                required: false
                type: string

permissions:
    contents: read
    packages: read

jobs:
    deploy:
        runs-on: ubuntu-latest
        steps:
            -   name: Resolve image to deploy
                id: img
                shell: bash
                run: |
                    REPO="ghcr.io/${{ github.repository }}"
                    if [ "${{ github.event_name }}" = "release" ]; then
                      TAG="${{ github.event.release.tag_name }}"
                      echo "image=${REPO}:${TAG}" >> "$GITHUB_OUTPUT"
                    else
                      TAG="${{ inputs.tag }}"
                      if [ -z "$TAG" ]; then
                        echo "Please provide 'tag' when running manually." >&2
                        exit 1
                      fi
                      echo "image=${REPO}:${TAG}" >> "$GITHUB_OUTPUT"
                    fi

            -   name: Deploy over SSH
                uses: appleboy/ssh-action@v1
                with:
                    host: ${{ secrets.DEPLOY_HOST }}
                    username: ${{ secrets.DEPLOY_USER }}
                    key: ${{ secrets.SSH_PRIVATE_KEY }}
                    script_stop: true
                    command_timeout: 30m
                    script: |
                        echo "Deploying IMAGE=${{ steps.img.outputs.image }}"
                        IMAGE="${{ steps.img.outputs.image }}" NAME="todolist" PORT="8080" bash /opt/todolist/deploy.sh
